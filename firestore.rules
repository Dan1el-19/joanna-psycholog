rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is admin with admin: true
    function isAdminUser() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    // Helper function to check if user is authenticated (anonymous or admin)
    function isAuthenticated() {
      return request.auth != null;
    }


    // KOLEKCJA "mail" - Zawsze zablokowana dla klienta
    match /mail/{emailId} {
      // Only Cloud Functions can write emails
      allow read, write: if false;
    }

    // KOLEKCJA "appointments"
    match /appointments/{appointmentId} {
      // Allow public appointment creation from the booking form
      // (no authentication required)
      allow create: if true;
      
  // Admins can read all appointment details
  // A user can read their own appointment if they provide the correct reservation token
  // Note: access token is expected as a query parameter named 'token'
  allow read: if isAdminUser() || (resource.data.reservationToken == request.query.token);

      // Only admins can list all appointments
      allow list: if isAdminUser();
      
      // Only admins can update appointments
      allow update: if isAdminUser();

      // No deletion allowed
      allow delete: if false;
    }

    // KOLEKCJA "users" - konfiguracja użytkowników (w tym administratorów)
    match /users/{userId} {
      // Users can read their own data
      allow read: if request.auth != null && request.auth.uid == userId;
      // Only admins can write user data
      allow write: if isAdminUser();
    }

    // KOLEKCJA "scheduleTemplates" - szablony grafików
    match /scheduleTemplates/{templateId} {
      // Public reads are required for calendar generation on the public site
      allow read: if true;
      // Only admins can write templates
      allow write: if isAdminUser();
    }

    // KOLEKCJA "templateAssignments" - przypisania szablonów do miesięcy
    match /templateAssignments/{assignmentId} {
      // Public reads for calendar availability
      allow read: if true;
      // Only admins can write template assignments
      allow write: if isAdminUser();
    }

    // KOLEKCJA "monthlySchedules" - grafiki miesięczne
    match /monthlySchedules/{scheduleId} {
      // Public reads for availability checking
      allow read: if true;
      // Only admins can write schedules
      allow write: if isAdminUser();
    }

    // KOLEKCJA "blockedSlots" - zablokowane terminy
    match /blockedSlots/{blockId} {
      // Public reads for availability checking
      allow read: if true;
      // Only admins can write blocked slots
      allow write: if isAdminUser();
    }

    // KOLEKCJA "reservationTokens" - tokeny zarządzania rezerwacją
    match /reservationTokens/{tokenId} {
      // Authenticated users can read tokens for validation
      allow read: if isAuthenticated();
      // Only Cloud Functions can write tokens
      allow write: if false;
    }

    // KOLEKCJA "temporaryBlocks" - tymczasowe blokady terminów
    match /temporaryBlocks/{blockId} {
      // Allow public creation and reading of temporary blocks used by the booking UI
      // (these documents are short-lived and identified by sessionId)
      allow create, read: if true;
      // Allow updates/deletes only from the client that created the block
      allow update, delete: if request.resource.data.sessionId == resource.data.sessionId || request.auth != null && isAdminUser();
    }

    // KOLEKCJA "feedback" - opinie klientów
    match /feedback/{feedbackId} {
      // Anonymous users can create feedback
      allow create: if isAuthenticated();
      // Only admins can read and update feedback
      allow read, update: if isAdminUser();
      // No deletion allowed
      allow delete: if false;
    }

    // KOLEKCJA "adminSessions" - sesje administratorów (opcjonalne)
    match /adminSessions/{sessionId} {
      // Only admins can manage their own sessions
      allow read, write: if isAdminUser() && request.auth.uid == resource.data.userId;
    }

    // KOLEKCJA "services" - dostępne usługi/produkty
    match /services/{serviceId} {
      // Public reads for services used in the booking form and calendar
      allow read: if true;
      // Only admins can write services
      allow write: if isAdminUser();
    }

    // KOLEKCJA "contactMessages" - wiadomości z formularza kontaktowego
    match /contactMessages/{messageId} {
      // Anyone can create contact messages (public contact form)
      allow create: if true;
      // Only admins can read contact messages
      allow read: if isAdminUser();
      // Only Cloud Functions can update messages (to mark as processed)
      allow update: if false;
      // No deletion allowed
      allow delete: if false;
    }
  }
}